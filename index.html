<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우리 동네 아파트 실거래가 대시보드</title>
    <!-- 1. Tailwind CSS (스타일링) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Chart.js (차트 시각화) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 3. PapaParse (CSV 파싱) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        /* 로딩 스피너 색상도 초록색(#16a34a)으로 변경 */
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #16a34a; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* 테이블 헤더 고정용 스타일 */
        .table-container { max-height: 500px; overflow-y: auto; }
        thead th { position: sticky; top: 0; background-color: #f8fafc; z-index: 10; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- 헤더 영역 -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">우리 동네 아파트 실거래가 대시보드</h1>
                <p class="text-slate-500 mt-1">실시간 구글 시트 데이터를 기반으로 분석한 실거래가 정보입니다.</p>
            </div>
            <div id="lastUpdate" class="text-sm font-medium text-slate-400">데이터 로딩 중...</div>
        </header>

        <!-- 로딩 상태 표시 -->
        <div id="loader" class="flex flex-col items-center justify-center py-20">
            <div class="loading-spinner mb-4"></div>
            <p class="text-slate-600 font-medium">실시간 거래 데이터를 불러오는 중입니다...</p>
        </div>

        <!-- 대시보드 본문 (로딩 완료 전까지 숨김) -->
        <div id="content" class="hidden">
            <!-- 1. 핵심 지표 요약 (Summary Stats) - 테두리와 숫자 색상을 초록색으로 통일 -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="card p-6 border-l-4 border-green-500">
                    <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider">전체 거래 건수</p>
                    <p id="statTotalCount" class="text-3xl font-bold text-green-700 mt-2">0건</p>
                </div>
                <div class="card p-6 border-l-4 border-green-500">
                    <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider">평균 거래가격</p>
                    <p id="statAvgPrice" class="text-3xl font-bold text-green-700 mt-2">0만원</p>
                </div>
                <div class="card p-6 border-l-4 border-green-500">
                    <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider">최고 거래가격</p>
                    <p id="statMaxPrice" class="text-3xl font-bold text-green-700 mt-2">0만원</p>
                </div>
                <div class="card p-6 border-l-4 border-green-500">
                    <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider">최저 거래가격</p>
                    <p id="statMinPrice" class="text-3xl font-bold text-green-700 mt-2">0만원</p>
                </div>
            </div>

            <!-- 2. 월별 평균 거래가격 차트 -->
            <div class="card p-6 mb-8">
                <h2 class="text-xl font-bold text-slate-800 mb-6">월별 평균 거래가격 추이</h2>
                <div class="h-[400px]">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <!-- 3. 거래 목록 테이블 -->
            <div class="card overflow-hidden">
                <div class="p-6 border-b border-slate-100">
                    <h2 class="text-xl font-bold text-slate-800">전체 거래 목록</h2>
                    <p class="text-sm text-slate-500 mt-1">최신 거래일자 순으로 정렬되어 있습니다. (15억 이상 거래는 빨간색으로 표시됩니다)</p>
                </div>
                <div class="table-container">
                    <table class="w-full text-left border-collapse min-w-[800px]">
                        <thead>
                            <tr class="text-slate-600 text-sm font-semibold shadow-sm">
                                <th class="p-4 border-b">거래일자</th>
                                <th class="p-4 border-b">아파트명</th>
                                <th class="p-4 border-b">법정동</th>
                                <th class="p-4 border-b">전용면적(㎡)</th>
                                <th class="p-4 border-b">층</th>
                                <th class="p-4 border-b">건축년도</th>
                                <th class="p-4 border-b text-right">거래금액(만원)</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="text-slate-700 text-sm">
                            <!-- JS로 데이터가 삽입되는 영역 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 에러 메시지 표시 영역 -->
        <div id="errorBox" class="hidden card p-8 text-center text-rose-600 mt-8">
            <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <p class="text-lg font-bold">데이터를 불러오는데 실패했습니다.</p>
            <p class="text-sm mt-2 text-slate-600">CSV URL이 올바른지 확인해 주세요. (CORS 문제나 공유 권한 문제일 수 있습니다)</p>
        </div>
    </div>

    <script>
        // 사용자 제공 구글 시트 CSV URL
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwXrQ5skcwUxoOZ_GbR12qiaa93Py9FL3qVvWUTvqTdED5VKdTJoqohgGcV1RsIj2qBRI9U8BgS7eE/pub?gid=103844759&single=true&output=csv';

        let priceChart = null;

        // 초기 데이터 로드 함수
        async function fetchData() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processData(results.data);
                },
                error: function(err) {
                    console.error('CSV 파싱 에러:', err);
                    showError();
                }
            });
        }

        // 데이터 가공 및 대시보드 렌더링
        function processData(data) {
            if (!data || data.length === 0) {
                showError();
                return;
            }

            // 1. 데이터 클렌징 (숫자형 변환 및 결측치 제거)
            const cleanedData = data.map(item => {
                const rawPrice = item['거래금액(만원)'] || '0';
                const price = parseFloat(rawPrice.replace(/,/g, '')); // 쉼표 제거 후 숫자로 변환
                
                // 거래일자(YYYYMMDD 형태 가정)를 기반으로 월별 그룹화를 위한 키(YYYY-MM) 생성
                const dateStr = String(item['거래일자']).trim();
                let yearMonth = '알 수 없음';
                if (dateStr.length >= 6) {
                    yearMonth = dateStr.substring(0, 4) + '-' + dateStr.substring(4, 6);
                }

                return {
                    ...item,
                    price: price,
                    yearMonth: yearMonth
                };
            }).filter(item => !isNaN(item.price) && item.price > 0);

            // 최신 거래일자 순으로 정렬 (내림차순)
            cleanedData.sort((a, b) => b['거래일자'] - a['거래일자']);

            // 2. 요약 지표 계산
            const prices = cleanedData.map(d => d.price);
            const totalCount = cleanedData.length;
            const avgPrice = prices.reduce((a, b) => a + b, 0) / totalCount;
            const maxPrice = Math.max(...prices);
            const minPrice = Math.min(...prices);

            // DOM에 지표 업데이트
            document.getElementById('statTotalCount').innerText = `${totalCount.toLocaleString()}건`;
            document.getElementById('statAvgPrice').innerText = `${Math.round(avgPrice).toLocaleString()}만원`;
            document.getElementById('statMaxPrice').innerText = `${maxPrice.toLocaleString()}만원`;
            document.getElementById('statMinPrice').innerText = `${minPrice.toLocaleString()}만원`;
            
            const now = new Date();
            document.getElementById('lastUpdate').innerText = `최종 업데이트: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

            // 3. 거래 목록 테이블 생성
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            cleanedData.forEach((row, index) => { 
                const tr = document.createElement('tr');
                
                // 짝수/홀수 줄무늬 패턴 및 호버 색상(green-100) 적용
                const bgClass = index % 2 === 0 ? 'bg-white' : 'bg-slate-50';
                tr.className = `${bgClass} hover:bg-green-100 transition-colors border-b border-slate-200`;
                
                // 전용면적 소수점 포맷팅
                const area = parseFloat(row['전용면적(㎡)']);
                const displayArea = !isNaN(area) ? area.toFixed(2) : row['전용면적(㎡)'];

                // 15억(150,000만 원) 이상일 경우 빨간색(rose-600) 강조
                const priceColorClass = row.price >= 150000 ? 'text-rose-600' : 'text-green-600';

                tr.innerHTML = `
                    <td class="p-4 whitespace-nowrap text-slate-500">${formatDate(row['거래일자'])}</td>
                    <td class="p-4 font-bold text-slate-800">${row['아파트명']}</td>
                    <td class="p-4 text-slate-600">${row['법정동']}</td>
                    <td class="p-4 text-slate-600">${displayArea}</td>
                    <td class="p-4 text-slate-600">${row['층']}층</td>
                    <td class="p-4 text-slate-600">${row['건축년도']}년</td>
                    <td class="p-4 text-right font-bold ${priceColorClass} text-base">${row.price.toLocaleString()}</td>
                `;
                tableBody.appendChild(tr);
            });

            // 4. 월별 평균 차트 데이터 생성
            const monthlyStats = {};
            cleanedData.forEach(item => {
                if (item.yearMonth === '알 수 없음') return;
                
                if (!monthlyStats[item.yearMonth]) {
                    monthlyStats[item.yearMonth] = { total: 0, count: 0 };
                }
                monthlyStats[item.yearMonth].total += item.price;
                monthlyStats[item.yearMonth].count += 1;
            });

            // 시간순 정렬을 위해 라벨(YYYY-MM) 오름차순 정렬
            const labels = Object.keys(monthlyStats).sort();
            const chartData = labels.map(label => Math.round(monthlyStats[label].total / monthlyStats[label].count));

            renderChart(labels, chartData);

            // 로딩 UI 숨기고 대시보드 표시
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }

        // Chart.js 렌더링 함수
        function renderChart(labels, data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (priceChart) priceChart.destroy(); // 기존 차트 초기화

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '월별 평균 거래가 (만원)',
                        data: data,
                        // 차트 선, 배경, 포인트 색상을 초록색(#16a34a)으로 통일
                        borderColor: '#16a34a',
                        backgroundColor: 'rgba(22, 163, 74, 0.1)',
                        borderWidth: 3,
                        tension: 0.4, // 부드러운 곡선
                        fill: true,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#16a34a',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString() + ' 만원';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                callback: value => value.toLocaleString() + '만'
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // 날짜 포맷 변환 유틸리티 (YYYYMMDD -> YYYY-MM-DD)
        function formatDate(val) {
            const str = String(val).trim();
            if (str.length === 8) {
                return `${str.substring(0,4)}-${str.substring(4,6)}-${str.substring(6,8)}`;
            }
            return val;
        }

        // 에러 처리 화면 표시
        function showError() {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('errorBox').classList.remove('hidden');
        }

        // 페이지 로드 시 데이터 패치 시작
        window.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>
